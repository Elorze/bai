# 南塘共创营：任务池聚合（LP化）场景 - 代码实现情况说明

## 📋 需求概述

在南塘村的老墙上构建交互式空间，包含三个子任务：
- **任务A（艺术/策展）**：墙面艺术创作与视觉设计，初始权重70%
- **任务B（技术/工程）**：互动硬件安装与环境修缮，初始权重20%
- **任务C（内容/数字）**：口述历史采集，初始权重10%

核心机制：
1. **全等式结算**：A + B + C 全部完成且验收通过，合约才释放激励
2. **动态权重调节**：如果某个子任务长期未领取，自动增加其权重
3. **池化质押**：120积分一次性质押进智能合约
4. **链上存证**：劳动证明上传至IPFS

---

## ✅ 已完成功能

### 1. 基础任务系统

#### 1.1 任务创建与管理
- ✅ **任务创建功能**
  - 支持创建任务，包含标题、描述、奖励等基本信息
  - 支持多人任务，可设置参与人数上限
  - 支持指定参与人员
  - 支持自定义奖励分配模式（每人平均分配或自定义权重）
  - 支持权重系数设置，但**仅支持静态权重**（创建时设定后不可动态调整）

#### 1.2 任务状态管理
- ✅ **任务状态流转**
  - 完整的状态流转：未领取 → 已领取 → 待提交 → 已提交 → 审核中 → 已完成/已驳回
  - 支持驳回后的重新提交、重新发布等操作选项
- ✅ **任务时间线记录**
  - 记录所有状态变化历史
  - 包含操作者、操作时间、操作理由等完整信息

#### 1.3 任务领取与提交
- ✅ **任务领取功能**
  - 支持单人任务和多人任务领取
  - 自动检查参与人数限制
  - 防止重复领取
- ✅ **凭证提交功能**
  - 支持照片、GPS定位、文字描述三种凭证类型
  - 可自定义凭证要求（如照片数量、文字字数等）

#### 1.4 任务审核
- ✅ **审核功能**
  - 支持审核通过/驳回
  - 支持转账完成标记
  - 注：打折审核功能接口已预留，但后端逻辑未完全实现

### 2. 数据库设计

#### 2.1 核心表结构
- ✅ **任务信息表**：存储多人任务的基本信息（所有参与者共享）
  - 包含标题、描述、时间、参与人数限制、奖励分配模式等
- ✅ **任务表**：每个行代表一个创建者-领取者对
  - 支持多人任务（通过任务信息ID关联）
  - 包含权重系数字段，但**仅支持静态权重**
  - 每个参与者有独立的状态和奖励
- ✅ **任务时间线表**：记录任务状态变化历史
- ✅ **任务凭证表**：存储任务完成凭证

#### 2.2 用户系统
- ✅ **用户认证**：手机号/邮箱登录
- ✅ **用户信息**：支持头像、姓名、简介等

### 3. 前端功能

#### 3.1 任务列表页面
- ✅ 显示所有任务列表
- ✅ 任务状态筛选功能
- ✅ 任务详情查看功能

#### 3.2 任务创建页面
- ✅ 完整的任务创建表单
- ✅ 凭证配置功能（照片、GPS、文字描述）
- ✅ 用户选择器（支持指定参与人员）

#### 3.3 任务详情页面
- ✅ 任务详情展示
- ✅ 任务领取/提交功能

---

## ❌ 未完成功能（核心需求）

### 1. 任务池（LP化）概念 ⚠️ **核心缺失**

**需求**：将A、B、C三个子任务聚合为一个任务池，共享120积分激励。

**现状**：
- ❌ 没有任务池的概念
- ❌ 没有父子任务关系
- ❌ 任务之间是独立的，没有关联关系
- ❌ 无法将多个任务聚合为一个任务池

**需要实现**：
- 需要新增任务池数据表，用于存储任务池的基本信息（总激励、状态等）
- 需要修改任务表结构，添加任务池关联字段和子任务标识
- 需要实现任务池与子任务的关联关系管理

### 2. 动态权重调节机制 ⚠️ **核心缺失**

**需求**：
- 如果子任务C长期处于 `unclaimed` 状态，自动增加其权重
- 计算公式：`W_i(t) = W_i(0) + ΔW · f(t - T_threshold)`
- 权重增加从任务A的份额中按比例扣除

**现状**：
- ❌ 没有动态权重计算逻辑
- ❌ 权重系数字段存在，但**仅支持静态权重**（创建时设定后不可动态调整）
- ❌ 没有定时任务或触发器来检测未领取任务
- ❌ 没有权重调节的API接口

**需要实现**：
- 需要实现动态权重计算服务，根据时间自动调整权重
- 需要配置权重调节参数（触发时间阈值、调节速率、调节函数等）
- 需要定时任务检查未领取的子任务，自动触发权重调节
- 需要提供API接口返回实时权重分配情况

### 3. 全等式结算逻辑 ⚠️ **核心缺失**

**需求**：
- 只有当 A、B、C 三个子任务**全部完成且验收通过**时，才释放激励
- 逻辑：`State(A) ∧ State(B) ∧ State(C) → Distribute(Rewards)`

**现状**：
- ❌ 没有全等式结算逻辑
- ❌ 每个任务独立结算，没有依赖关系
- ❌ 没有检查所有子任务是否完成的机制

**需要实现**：
- 需要实现任务池结算检查服务
- 在任务审核通过时自动检查所有子任务状态
- 只有当所有子任务都完成时，才触发激励分配流程
- 需要与智能合约集成，实现链上结算

### 4. 智能合约质押 ⚠️ **完全未实现**

**需求**：
- 120积分一次性质押进智能合约
- 确保激励的确定性（钱已在链上，干完必得）

**现状**：
- ❌ 没有智能合约代码
- ❌ 没有链上质押功能
- ❌ 没有与区块链交互的代码
- ❌ 奖励分配仅在数据库层面，没有链上执行

**需要实现**：
- 需要编写智能合约代码，实现任务池的链上管理
- 需要实现链上质押功能，将120积分锁定在智能合约中
- 需要实现子任务完成状态的链上记录
- 需要实现全等式结算的链上逻辑
- 需要实现链上激励分配功能
- 需要后端服务与智能合约交互，实现链上操作

### 5. IPFS链上存证 ⚠️ **完全未实现**

**需求**：
- 劳动证明上传至IPFS
- 链上存证，例如："2024年深秋，志愿者[姓名]提笔南塘南墙..."

**现状**：
- ❌ 没有IPFS集成
- ❌ 凭证仅存储在数据库中，没有上传到IPFS
- ❌ 没有链上存证功能

**需要实现**：
- 需要集成IPFS客户端，实现凭证上传功能
- 需要修改凭证提交流程，在提交时自动上传到IPFS
- 需要将IPFS哈希存储到数据库和智能合约中
- 需要实现链上存证功能，确保劳动证明的不可篡改性

### 6. 动态权重调节的前端展示 ⚠️ **未实现**

**需求**：
- 前端展示实时权重变化
- 显示权重调节的原因（如"任务C未领取，权重已提升"）

**现状**：
- ❌ 前端没有权重展示组件
- ❌ 没有权重变化的时间线

---

## 📊 功能完成度统计

| 功能模块 | 完成度 | 说明 |
|---------|--------|------|
| 基础任务系统 | 90% | 任务创建、领取、提交、审核基本完成 |
| 多人任务支持 | 80% | 支持多人任务，但缺少任务池概念 |
| 权重分配 | 30% | 仅支持静态权重，缺少动态调节 |
| 全等式结算 | 0% | 完全未实现 |
| 智能合约 | 0% | 完全未实现 |
| IPFS存证 | 0% | 完全未实现 |
| 动态权重UI | 0% | 完全未实现 |

**总体完成度：约 35%**

---

## 🔧 技术债务

1. **数据库设计**：
   - 缺少任务池数据表
   - 缺少任务池与子任务的关联关系设计
   - 缺少动态权重历史记录表

2. **后端服务**：
   - 缺少任务池管理服务
   - 缺少动态权重计算服务
   - 缺少全等式结算检查服务
   - 缺少IPFS集成服务
   - 缺少智能合约交互服务

3. **前端功能**：
   - 缺少任务池创建页面
   - 缺少子任务管理界面
   - 缺少权重变化可视化组件
   - 缺少任务池结算状态展示

---

## 🎯 下一步开发建议

### 优先级1（核心功能）
1. **实现任务池概念**
   - 创建任务池数据表
   - 修改任务创建流程，支持创建任务池和子任务
   - 实现任务池与子任务的关联关系管理

2. **实现全等式结算逻辑**
   - 在任务审核通过时检查所有子任务状态
   - 如果全部完成，触发结算流程
   - 与智能合约集成，实现链上结算

3. **实现智能合约质押**
   - 编写智能合约代码
   - 实现链上质押和结算功能
   - 集成到后端服务

### 优先级2（增强功能）
4. **实现动态权重调节**
   - 实现权重计算算法
   - 添加定时任务检查未领取任务
   - 实现权重调节API接口

5. **实现IPFS存证**
   - 集成IPFS客户端
   - 修改凭证提交流程，上传到IPFS
   - 在智能合约中存储IPFS哈希

### 优先级3（用户体验）
6. **前端优化**
   - 创建任务池管理界面
   - 实现权重变化可视化
   - 优化任务池结算状态展示

---

## 💡 总结

当前代码已经实现了**基础的任务管理系统**，包括任务创建、领取、提交、审核等核心功能，但**缺少任务池（LP化）场景的核心机制**：

1. ❌ **任务池概念**：没有将多个子任务聚合为一个任务池
2. ❌ **动态权重调节**：权重是静态的，无法根据时间自动调整
3. ❌ **全等式结算**：没有"全部完成才释放"的逻辑
4. ❌ **智能合约质押**：没有链上质押和结算功能
5. ❌ **IPFS存证**：凭证存储在数据库，没有上传到IPFS

**建议优先实现任务池概念和全等式结算逻辑**，这是整个场景的核心基础。
